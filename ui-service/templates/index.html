<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Packet Analyzer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <style>
    body { background-color: #f8f9fa; }
    .card { margin-bottom: 1rem; }
    .status-idle { color: gray; font-weight: bold; }
    .status-running { color: green; font-weight: bold; }
    .status-stopped { color: red; font-weight: bold; }
    /* ðŸŽ¯ Smaller chart size */
    #protocolChart {
      max-width: 200px;
      max-height: 200px;
      margin: 0 auto;
    }
  </style>
</head>
<body>
<div class="container-fluid mt-3">
  <h3 class="mb-3">ðŸ“¡ Packet Analyzer</h3>

  <!-- Controls -->
  <div class="row">
    <div class="col-md-6">
      <div class="card p-3">
        <h5>Sniffing Controls</h5>
        <button class="btn btn-success" onclick="startSniffing()">Start Sniffing</button>
        <button class="btn btn-danger" onclick="stopSniffing()">Stop Sniffing</button>
        <span id="sniff-status" class="ms-3 status-idle">Idle</span>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card p-3">
        <h5>Source Filters</h5>
        <a href="/" class="btn btn-dark">All Packets</a>
        <a href="/?source=LIVE" class="btn btn-danger">LIVE Packets</a>
        <a href="/?source=PCAP" class="btn btn-primary">PCAP Packets</a>
      </div>
    </div>
  </div>

  <!-- Summary + Chart -->
  <div class="row">
    <div class="col-md-6">
      <div class="card p-3">
        <div class="d-flex justify-content-between">
          <h5>Protocol Summary</h5>
          <div>
            <a href="/api/all_protocols" class="btn btn-sm btn-outline-secondary">All Protocols</a>
            <button class="btn btn-sm btn-outline-primary" onclick="refreshSummary()">ðŸ”„ Refresh</button>
          </div>
        </div>
        <ul id="protocol-list">
          {% for proto, counts in summary.items() %}
          <li>
            <a href="/?protocol={{ proto }}&source={{ selected_source|default('LIVE') }}">{{ proto }}</a>
            {% for src, count in counts.items() %}
              ({{ src }}={{ count }})
            {% endfor %}
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card p-3 text-center">
        <h5>Protocol Distribution</h5>
        <canvas id="protocolChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Packet Table -->
  <div class="card p-3">
    <h5>
      Packet List
      {% if selected %}<span class="badge bg-info">Protocol: {{ selected }}</span>{% endif %}
      {% if selected_source %}<span class="badge bg-secondary">Source: {{ selected_source }}</span>{% endif %}
    </h5>
    <div class="table-responsive">
      <table id="packetTable" class="table table-striped table-bordered">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Source IP</th>
            <th>Dest IP</th>
            <th>Protocol</th>
            <th>Summary</th>
            <th>UTC</th>
            <th>IST</th>
            <th>Source</th>
          </tr>
        </thead>
        <tbody>
          {% for p in packets %}
          <tr>
            <td>{{ p.id }}</td>
            <td>{{ p.src_ip }}</td>
            <td>{{ p.dst_ip }}</td>
            <td><span class="badge bg-info">{{ p.protocol }}</span></td>
            <td>{{ p.summary }}</td>
            <td>{{ p.timestamp }}</td>
            <td>{{ p.timestamp | to_datetime | to_ist }}</td>
            <td>{{ p.source }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
let chart;

// Refresh summary + chart
function refreshSummary() {
  fetch("/api/summary")
    .then(res => res.json())
    .then(data => {
      // Update list
      let list = document.getElementById("protocol-list");
      list.innerHTML = "";
      for (const [proto, counts] of Object.entries(data)) {
        let li = document.createElement("li");
        let a = document.createElement("a");
        a.href = `/?protocol=${proto}&source=LIVE`;
        a.innerText = proto;
        li.appendChild(a);
        for (const [src, count] of Object.entries(counts)) {
          li.innerHTML += ` (${src}=${count})`;
        }
        list.appendChild(li);
      }

      // Update chart
      let labels = Object.keys(data);
      let values = labels.map(p => Object.values(data[p]).reduce((a,b)=>a+b,0));
      let colors = ["#7E57C2","#42A5F5","#66BB6A","#FFA726","#EF5350","#26C6DA","#AB47BC"];
      if (chart) chart.destroy();
      chart = new Chart(document.getElementById("protocolChart"), {
        type: "doughnut",
        data: { labels, datasets: [{ data: values, backgroundColor: colors }] },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    });
}

// Sniffing Controls
function startSniffing() {
  fetch("/api/start_sniffing", { method: "POST" })
    .then(res => res.json())
    .then(() => {
      document.getElementById("sniff-status").innerText = "âœ… Sniffing Started";
      document.getElementById("sniff-status").className = "status-running";
    });
}
function stopSniffing() {
  fetch("/api/stop_sniffing", { method: "POST" })
    .then(res => res.json())
    .then(() => {
      document.getElementById("sniff-status").innerText = "ðŸ›‘ Sniffing Stopped";
      document.getElementById("sniff-status").className = "status-stopped";
    });
}

// DataTable + auto-refresh
$(document).ready(function () {
  $('#packetTable').DataTable({
    pageLength: 25,
    order: [[0, "desc"]]
  });

  // auto refresh every 2s
  setInterval(refreshSummary, 2000);
});
</script>
</body>
</html>